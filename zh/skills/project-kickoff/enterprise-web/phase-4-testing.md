# Phase 4: 测试策略

> **阶段目标**: 建立分层测试体系，支持 TDD 开发  
> **前置条件**: 已完成系统设计、业务规则定义  
> **核心产出**: 测试用例文档、测试代码框架

---

## 1. 测试金字塔

```
         ▲
        /│\         E2E 测试 (少量)
       / │ \        • 关键业务流程
      /  │  \       • 人工执行为主
     /───┼───\      
    /    │    \     集成测试 (适量)
   /     │     \    • API 接口测试
  /──────┼──────\   • 自动化 (pytest + httpx)
 /       │       \  
/────────┼────────\ 单元测试 (大量)
         │          • 校验函数、状态机、工具函数
         │          • 自动化 (pytest)
```

**原则**：底层测试多、上层测试少；底层自动化、上层可人工

---

## 2. TDD 工作流

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 1. 写测试   │ ──► │ 2. 运行失败 │ ──► │ 3. 实现代码 │
│    用例文档 │     │    (红)     │     │             │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
       ┌───────────────────────────────────────┘
       ▼
┌─────────────┐     ┌─────────────┐
│ 4. 运行通过 │ ──► │ 5. 重构     │
│    (绿)     │     │    (保持绿) │
└─────────────┘     └─────────────┘
```

### 2.1 TDD 适用范围

| 适合 TDD | 不太适合 TDD |
|----------|--------------|
| 校验函数 | UI 界面 |
| 状态机逻辑 | 第三方集成 |
| API 接口 | 探索性开发 |
| 工具函数 | 快速原型 |
| 计算逻辑 | |

---

## 3. 测试用例文档结构

### 3.1 单元测试用例 (unit-tests.md)

```markdown
## 1. 用户名校验 (validate_username)

| ID | 输入 | 预期 | 说明 |
|----|------|:----:|------|
| UN-01 | `""` | ❌ | 空 |
| UN-02 | `"ab"` | ❌ | <3字符 |
| UN-03 | `"abc"` | ✅ | 最小长度 |
| UN-04 | `"123abc"` | ❌ | 数字开头 |

对应 pytest 代码：

```python
@pytest.mark.parametrize("username,valid", [
    ("", False), ("ab", False), ("abc", True), ("123abc", False),
])
def test_username(username, valid):
    result, _ = validate_username(username)
    assert result == valid
```
```

### 3.2 API 测试用例 (api-tests.md)

```markdown
## 1. 用户登录 POST /api/v1/auth/login

| ID | 场景 | 预期码 | 预期响应 |
|----|------|:------:|----------|
| LOGIN-01 | 正常登录 | 200 | 返回 token |
| LOGIN-02 | 用户名错误 | 401 | code=40101 |
| LOGIN-03 | 密码错误 | 401 | code=40101 |
| LOGIN-04 | 账户锁定 | 403 | code=40304 |
```

### 3.3 E2E 测试 Checklist (e2e-checklist.md)

```markdown
## E2E-001: 用户注册到提交任务

**前置条件**: 系统已部署，有管理员账号

| # | 操作 | 预期结果 | ✓ |
|:-:|------|----------|:-:|
| 1 | 访问注册页 | 显示表单 | ⬜ |
| 2 | 填写信息并提交 | 显示"等待审核" | ⬜ |
| 3 | 管理员审核通过 | 用户状态变 active | ⬜ |
| 4 | 用户登录并提交任务 | 任务显示"排队中" | ⬜ |

**结果**: ⬜ 通过 / ⬜ 失败
```

---

## 4. 测试文件组织

```
project/
├── docs/
│   └── test-cases/
│       ├── unit-tests.md       # 单元测试用例（人类可读）
│       ├── api-tests.md        # API 测试用例
│       └── e2e-checklist.md    # E2E 测试清单
├── tests/
│   ├── conftest.py             # pytest 配置和 fixtures
│   ├── unit/
│   │   ├── test_validators.py
│   │   ├── test_state_machines.py
│   │   └── test_utils.py
│   ├── integration/
│   │   ├── test_auth_api.py
│   │   ├── test_user_api.py
│   │   └── test_task_api.py
│   └── e2e/
│       └── E2E-CHECKLIST.md    # 执行记录
```

---

## 5. 各类型测试要点

### 5.1 单元测试

**覆盖内容**：
- 所有校验函数（用户名、密码、邮箱、唤醒词等）
- 状态机转换（用户状态、任务状态）
- 计算逻辑（锁定时间、队列位置）
- 工具函数

**编写原则**：
- 使用 `@pytest.mark.parametrize` 做参数化测试
- 每个函数至少覆盖：正常情况、边界情况、错误情况
- 测试应该快速、独立、可重复

### 5.2 API 集成测试

**覆盖内容**：
- 所有 API 端点
- 正常流程和错误流程
- 权限验证
- 数据验证

**编写原则**：
- 使用测试数据库，每次测试前重置
- 使用 fixtures 创建测试用户、测试数据
- 验证状态码和响应结构

### 5.3 E2E 测试

**覆盖内容**：
- 核心业务流程（注册→审核→提交任务→下载）
- 权限校验流程
- 异常流程（登录锁定、审核拒绝等）

**执行方式**：
- 每次发布前人工执行
- 按 Checklist 逐项勾选
- 记录执行结果和问题

---

## 6. 测试运行命令

```bash
# 运行所有单元测试
pytest tests/unit/ -v

# 运行所有集成测试
pytest tests/integration/ -v

# 运行所有测试 + 覆盖率
pytest --cov=app --cov-report=html

# 只运行特定文件
pytest tests/unit/test_validators.py -v

# 只运行匹配关键字的测试
pytest -k "username" -v

# 失败时停止
pytest -x

# 显示详细输出
pytest -v --tb=short
```

---

## 7. 与开发流程的集成

### 7.1 功能开发流程

```
1. 阅读需求/设计文档
2. 编写测试用例文档（先写 .md）
3. 将测试用例转为 pytest 代码
4. 运行测试，确认失败（红）
5. 实现功能代码
6. 运行测试，确认通过（绿）
7. 重构代码，保持测试通过
8. 提交代码
```

### 7.2 发布前检查

```
1. 运行所有自动化测试
2. 执行 E2E Checklist
3. 检查测试覆盖率
4. 确认无失败测试
5. 发布
```

---

## 8. Agent 使用说明

当用户说"帮我写测试"或"建立测试体系"时：

1. **询问测试范围**：单元测试？API 测试？E2E？
2. **先写用例文档**：用 Markdown 表格形式
3. **转为代码**：根据用例生成 pytest 代码
4. **建议目录结构**：按上述结构组织

---

## 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v1.0 | 2025-01-27 | 初始版本 |
